<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Sales CRM ‚Äî Kande VendTech</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1a202c;
      --muted: #718096;
      --accent: #3182ce;
      --hot: #e53e3e;
      --warm: #dd6b20;
      --success: #38a169;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Nav */
    .top-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .top-nav .logo { height: 36px; }
    .top-nav a { color: var(--muted); text-decoration: none; font-size: 0.85rem; font-weight: 500; padding: 6px 12px; border-radius: 6px; transition: all 0.2s; }
    .top-nav a:hover, .top-nav a.active { color: var(--accent); background: rgba(49,130,206,0.08); }

    .app { max-width: 1200px; margin: 0 auto; padding: 20px; }

    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 24px; flex-wrap: wrap; gap: 16px;
    }
    .header h1 {
      font-size: 1.5rem;
      background: linear-gradient(90deg, var(--accent), #7b2cbf);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-actions { display: flex; gap: 12px; }

    .btn {
      padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 0.9rem; font-weight: 500; transition: all 0.2s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-danger { background: var(--hot); color: #fff; }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

    .stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px; margin-bottom: 24px;
    }
    .stat {
      background: var(--card); border-radius: 12px; padding: 16px;
      text-align: center; border: 1px solid var(--border);
    }
    .stat-value { font-size: 1.8rem; font-weight: 700; }
    .stat-value.hot { color: var(--hot); }
    .stat-value.accent { color: var(--accent); }
    .stat-value.warn { color: var(--warm); }
    .stat-label { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }

    .filters { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .filter-btn {
      padding: 8px 16px; background: var(--card); border: 1px solid var(--border);
      border-radius: 20px; color: var(--muted); cursor: pointer; font-size: 0.85rem;
    }
    .filter-btn:hover, .filter-btn.active {
      background: rgba(49,130,206,0.1); border-color: var(--accent); color: var(--accent);
    }
    .search-input {
      flex: 1; min-width: 200px; padding: 10px 16px; background: var(--card);
      border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem;
    }

    .prospect-list { display: flex; flex-direction: column; gap: 8px; }

    .prospect-card {
      background: var(--card); border-radius: 12px; border: 1px solid var(--border);
      cursor: pointer; transition: all 0.2s; overflow: hidden; position: relative;
    }
    .prospect-card:hover { border-color: var(--accent); }
    .prospect-card.hot { border-left: 4px solid var(--hot); }
    .prospect-card.warm { border-left: 4px solid var(--warm); }
    .prospect-card.expanded { border-color: var(--accent); cursor: default; }

    .prospect-summary { padding: 16px; }
    .prospect-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; gap: 8px; flex-wrap: wrap; }
    .prospect-name { flex: 1; min-width: 60%; }
    .contact-field-label { display: none; }
    .contact-field { gap: 2px; }
    .prospect-name { font-size: 1.1rem; font-weight: 600; }
    .prospect-badge {
      padding: 4px 10px; border-radius: 12px; font-size: 0.7rem;
      font-weight: 600; text-transform: uppercase;
    }
    .badge-hot { background: rgba(229,62,62,0.15); color: var(--hot); }
    .badge-warm { background: rgba(221,107,32,0.15); color: var(--warm); }
    .badge-new { background: rgba(49,130,206,0.15); color: var(--accent); }
    .badge-closed { background: rgba(160,174,192,0.15); color: #a0aec0; }
    .badge-signed { background: rgba(56,161,105,0.15); color: var(--success); }
    .badge-action { background: rgba(128,90,213,0.15); color: #805ad5; }
    .needs-action-btn {
      padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;
      cursor: pointer; border: 1px dashed #805ad5; color: #805ad5; background: transparent;
      text-transform: uppercase; transition: all 0.2s; white-space: nowrap;
    }
    .needs-action-btn.active { background: rgba(128,90,213,0.15); border-style: solid; }
    .needs-action-btn:hover { background: rgba(128,90,213,0.1); }

    #miniMap { height: 400px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px; }
    .address-link { color: var(--accent); text-decoration: none; }
    .address-link:hover { text-decoration: underline; }
    .prospect-meta { font-size: 0.85rem; color: var(--muted); }

    /* Expanded detail area */
    .prospect-detail {
      display: none; padding: 0 16px 16px; border-top: 1px solid var(--border);
    }
    .prospect-card.expanded .prospect-detail { display: block; }

    .detail-section {
      margin-top: 16px; padding: 14px; background: var(--bg);
      border-radius: 8px;
    }
    .detail-section-title {
      font-size: 0.8rem; font-weight: 600; text-transform: uppercase;
      color: var(--muted); margin-bottom: 10px; letter-spacing: 0.5px;
    }

    .field-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .field-group { display: flex; flex-direction: column; gap: 4px; }
    .field-group.full { grid-column: 1 / -1; }
    .field-label { font-size: 0.75rem; color: var(--muted); font-weight: 500; }
    .field-input {
      width: 100%; padding: 8px 10px; background: var(--card);
      border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); font-size: 0.9rem; font-family: inherit;
    }
    .field-input:focus { outline: none; border-color: var(--accent); }
    select.field-input { cursor: pointer; }
    textarea.field-input { min-height: 70px; resize: vertical; }

    .notes-box {
      margin-top: 12px; padding: 12px; background: var(--card);
      border-radius: 8px; border-left: 3px solid var(--accent);
    }
    .notes-box.kurtis { border-left-color: var(--warm); }
    .notes-box label {
      display: block; font-size: 0.8rem; font-weight: 600;
      margin-bottom: 6px;
    }
    .notes-box label.sales { color: var(--accent); }
    .notes-box label.kurtis { color: var(--warm); }
    .notes-box textarea {
      width: 100%; padding: 8px 10px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); font-size: 0.9rem; font-family: inherit;
      min-height: 60px; resize: vertical; overflow: hidden;
    }
    .notes-box textarea:focus { outline: none; border-color: var(--accent); }

    .action-bar {
      display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap;
      padding-top: 12px; border-top: 1px solid var(--border);
    }
    .action-btn {
      padding: 8px 14px; background: var(--card); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); cursor: pointer; font-size: 0.85rem;
    }
    .action-btn:hover { border-color: var(--accent); color: var(--accent); }
    .action-btn.danger { color: var(--hot); }
    .action-btn.danger:hover { border-color: var(--hot); }
    .action-btn.save { background: var(--accent); color: #fff; border-color: var(--accent); }
    .action-btn.save:hover { opacity: 0.9; }

    /* Activities inline */
    .activities-section { margin-top: 16px; }
    .activity-item {
      padding: 10px; background: var(--card); border-radius: 8px;
      border-left: 3px solid var(--accent); margin-bottom: 8px;
    }
    .activity-item.call { border-left-color: var(--accent); }
    .activity-item.pop-in { border-left-color: var(--success); }
    .activity-item.email { border-left-color: var(--warm); }
    .activity-type { font-size: 0.7rem; text-transform: uppercase; color: var(--muted); }
    .activity-desc { font-size: 0.85rem; margin-top: 2px; }
    .activity-date { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }

    /* Contacts inline */
    .contact-card {
      padding: 10px; background: var(--card); border-radius: 8px;
      margin-bottom: 8px;
    }

    /* Modals (kept for add prospect, log activity, add contact) */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--card); border-radius: 16px; width: 100%;
      max-width: 600px; max-height: 90vh; overflow-y: auto;
      border: 1px solid var(--border);
    }
    .modal-header {
      padding: 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; background: var(--card);
    }
    .modal-header h2 { font-size: 1.2rem; }
    .modal-close { background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; }
    .modal-body { padding: 20px; }
    .modal-footer {
      padding: 20px; border-top: 1px solid var(--border);
      display: flex; gap: 12px; justify-content: flex-end;
    }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 6px; }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 12px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 8px;
      color: var(--text); font-size: 0.95rem;
    }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }

    .saved-indicator {
      position: absolute; top: 8px; right: 8px; padding: 4px 10px; border-radius: 12px;
      font-size: 0.75rem; background: rgba(56,161,105,0.15); color: var(--success);
      opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1;
    }
    .saved-indicator.show { opacity: 1; }

    @media (max-width: 600px) {
      .field-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .header { flex-direction: column; align-items: flex-start; }
      .prospect-header { flex-wrap: wrap; justify-content: flex-start !important; }
      .prospect-name { width: 100%; }
      .badge-row { margin-left: 0 !important; }
      .contact-grid-header { display: none !important; }
      .contact-grid-row { grid-template-columns: 1fr !important; }
      .contact-grid-row .contact-delete { justify-self: start; }
      .contact-field-label { display: block !important; }
      .prop-info-grid { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>
  <div class="app">
    <nav class="top-nav">
      <a href="/"><img src="/logo.png" alt="Kande VendTech" class="logo"></a>
      <a href="/">Dashboard</a>
      <a href="/crm" class="active">CRM</a>
      <a href="/machines">Machines</a>
      <a href="/inventory">Inventory</a>
      <a href="/finance">Finance</a>
      <a href="/restock">Restock</a>
      <a href="/map">Map</a>
    </nav>
    <div class="header">
      <div style="display:flex;align-items:center;gap:12px;">
        <img src="/logo.png" alt="Kande VendTech" style="height:56px;">
        <h1>Sales CRM</h1>
        <div id="signedCounter" style="display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:12px;background:var(--success);color:#fff;font-size:1.2rem;font-weight:700;cursor:pointer;" onclick="document.querySelector('[data-filter=signed]').click()">
          ‚úÖ <span id="signedCount">0</span> Signed
        </div>
      </div>
      <div class="header-actions">
        <a href="/crm/map" class="btn btn-secondary" style="border-color:var(--accent);color:var(--accent);">üöó Route Planner</a>
        <button class="btn btn-primary" onclick="showAddModal()">+ New Prospect</button>
      </div>
    </div>

    <div id="miniMap"></div>

    <div class="stats" id="stats">
      <div class="stat"><div class="stat-value hot" id="statHot">-</div><div class="stat-label">üî• Hot Leads</div></div>
      <div class="stat"><div class="stat-value accent" id="statActive">-</div><div class="stat-label">Active</div></div>
      <div class="stat"><div class="stat-value warn" id="statFollowup">-</div><div class="stat-label">Need Follow-up</div></div>
      <div class="stat"><div class="stat-value" id="statWeek">-</div><div class="stat-label">Activities (7d)</div></div>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="hot">üî• Hot</button>
      <button class="filter-btn" data-filter="warm">üü† Warm</button>
      <button class="filter-btn" data-filter="new">üÜï New</button>
      <button class="filter-btn" data-filter="signed">‚úÖ Signed</button>
      <button class="filter-btn" data-filter="closed">‚õî Stale</button>
      <button class="filter-btn" data-filter="followup">üìã Needs Action</button>
      <input type="text" class="search-input" id="search" placeholder="Search prospects...">
    </div>

    <div class="prospect-list" id="prospectList">
      <div class="empty-state"><h3>Loading...</h3></div>
    </div>
  </div>

  <!-- Add Prospect Modal (only for new) -->
  <div class="modal-overlay" id="prospectModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Prospect</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="prospectForm">
          <div class="form-group">
            <label class="form-label">Property Name *</label>
            <input type="text" class="form-input" id="addName" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Property Type</label>
              <select class="form-select" id="addPropertyType">
                <option value="">Select...</option>
                <option value="Apartments">Apartments</option>
                <option value="Condos">Condos</option>
                <option value="Extended Stay">Extended Stay</option>
                <option value="Office">Office Building</option>
                <option value="Gym">Gym/Fitness</option>
                <option value="Warehouse">Warehouse</option>
                <option value="Senior Living">Senior Living</option>
                <option value="Skilled Nursing">Skilled Nursing</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label"># of Units</label>
              <input type="text" class="form-input" id="addUnits" placeholder="e.g., 100+">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Address</label>
            <input type="text" class="form-input" id="addAddress">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-input" id="addPhone">
            </div>
            <div class="form-group">
              <label class="form-label">Hours</label>
              <input type="text" class="form-input" id="addHours" placeholder="e.g., M-F 9-5">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addProspect()">Add Prospect</button>
      </div>
    </div>
  </div>

  <!-- Log Activity Modal -->
  <div class="modal-overlay" id="activityModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="activityTitle">Log Activity</h2>
        <button class="modal-close" onclick="closeActivityModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="activityForm">
          <input type="hidden" id="activityProspectId">
          <input type="hidden" id="activityType">
          <div class="form-group">
            <label class="form-label">What happened?</label>
            <textarea class="form-textarea" id="activityDesc" placeholder="Spoke with manager, showed them the catalog..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Outcome</label>
            <select class="form-select" id="activityOutcome">
              <option value="">Select...</option>
              <option value="interested">Interested - Follow up</option>
              <option value="thinking">Thinking about it</option>
              <option value="not_available">Contact not available</option>
              <option value="not_interested">Not interested</option>
              <option value="left_info">Left information</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Next Action</label>
              <input type="text" class="form-input" id="nextAction" placeholder="e.g., Send proposal">
            </div>
            <div class="form-group">
              <label class="form-label">Follow-up Date</label>
              <input type="date" class="form-input" id="nextActionDate">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeActivityModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveActivity()">Save Activity</button>
      </div>
    </div>
  </div>

  <!-- Add Contact Modal -->
  <div class="modal-overlay" id="contactModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Contact</h2>
        <button class="modal-close" onclick="closeContactModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="contactForm">
          <input type="hidden" id="contactProspectId">
          <div class="form-group">
            <label class="form-label">Name *</label>
            <input type="text" class="form-input" id="contactName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <input type="text" class="form-input" id="contactRole" placeholder="e.g., Property Manager">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="contactEmail">
            </div>
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-input" id="contactPhone">
            </div>
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="contactPrimary"> Primary contact</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveContact()">Save Contact</button>
      </div>
    </div>
  </div>

  <script>
    let prospects = [];
    let expandedId = null;
    let currentFilter = 'all';
    let saveTimers = {};

    async function loadData() {
      await Promise.all([loadStats(), loadProspects()]);
    }

    async function loadStats() {
      const res = await fetch('/api/stats');
      const s = await res.json();
      document.getElementById('statHot').textContent = s.hot;
      document.getElementById('statActive').textContent = s.active;
      document.getElementById('statFollowup').textContent = s.needsFollowup;
      document.getElementById('statWeek').textContent = s.thisWeek;
      document.getElementById('signedCount').textContent = s.signed || 0;
    }

    async function loadProspects() {
      const res = await fetch('/api/prospects');
      prospects = await res.json();
      renderProspects();
    }

    function renderProspects() {
      let filtered = prospects;
      const search = document.getElementById('search').value.toLowerCase();

      if (currentFilter === 'hot') filtered = filtered.filter(p => p.priority === 'hot');
      else if (currentFilter === 'warm') filtered = filtered.filter(p => p.priority === 'warm');
      else if (currentFilter === 'new') filtered = filtered.filter(p => p.status === 'new');
      else if (currentFilter === 'signed') filtered = filtered.filter(p => p.status === 'signed');
      else if (currentFilter === 'closed') filtered = filtered.filter(p => p.status === 'closed');
      else if (currentFilter === 'followup') filtered = filtered.filter(p => p.needs_action);

      if (search) {
        filtered = filtered.filter(p =>
          p.name.toLowerCase().includes(search) ||
          (p.address || '').toLowerCase().includes(search) ||
          (p.primary_contact || '').toLowerCase().includes(search)
        );
      }

      if (filtered.length === 0) {
        document.getElementById('prospectList').innerHTML = '<div class="empty-state"><h3>No prospects found</h3></div>';
        return;
      }

      document.getElementById('prospectList').innerHTML = filtered.map(p => `
        <div class="prospect-card ${p.priority} ${expandedId === p.id ? 'expanded' : ''}" id="card-${p.id}">
          <div class="prospect-summary" onclick="toggleExpand(${p.id})">
            <div class="prospect-header">
              <div class="prospect-name">${p.name}</div>
              <span class="saved-indicator" id="saved-${p.id}">‚úì Saved</span>
              <div class="badge-row" style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
                <span class="prospect-badge badge-${getBadgeClass(p)}" onclick="event.stopPropagation(); cycleTag(${p.id})" style="cursor:pointer;" title="Click to change">
                  ${getBadgeLabel(p)}
                </span>
                <button class="needs-action-btn ${p.needs_action ? 'active' : ''}" onclick="event.stopPropagation(); toggleNeedsAction(${p.id})" title="Toggle Needs Action">
                  üìã ${p.needs_action ? 'Action' : '+ Action'}
                </button>
              </div>
            </div>
            <div class="prospect-meta" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <span>${p.property_type || 'Unknown'} ${p.units ? '‚Ä¢ ' + p.units + ' units' : ''}
              ${p.address ? ' ‚Ä¢ <a href="https://www.google.com/maps/search/' + encodeURIComponent(p.address) + '" target="_blank" class="address-link" onclick="event.stopPropagation()">üìç ' + p.address + '</a>' : ''}</span>
              ${p.activities?.length ? `<span style="display:inline-flex;gap:4px;flex-wrap:nowrap;" onclick="event.stopPropagation()">
                ${groupActivitiesByDate(p.activities).slice(0, 8).map(([date, acts]) => `<span style="display:inline-flex;flex-direction:column;align-items:center;justify-content:center;min-width:54px;height:54px;border-radius:8px;font-size:0.7rem;background:rgba(49,130,206,0.08);color:var(--accent);border:1px solid rgba(49,130,206,0.15);" title="${acts.map(a => actIcon(a.type) + ' ' + esc(a.description || a.type)).join('\n')}"><span style="font-size:16px;">${acts.map(a => actIcon(a.type)).join('')}</span><span style="opacity:0.7;font-size:0.65rem;">${date}</span></span>`).join('')}
                ${groupActivitiesByDate(p.activities).length > 8 ? `<span style="min-width:54px;height:54px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-size:0.75rem;color:var(--muted);background:var(--bg);border:1px solid var(--border);">+${groupActivitiesByDate(p.activities).length - 8}</span>` : ''}
              </span>` : ''}
            </div>
            ${(p.contacts?.length || p.primary_contact) ? `<div style="margin-top:4px;font-size:0.85rem;">
              ${p.contacts?.length ? p.contacts.map(c => `<span style="color:var(--text);">${c.is_primary ? '‚≠ê ' : ''}${titleCase(c.name)}</span>${c.phone ? ' <a href="tel:' + c.phone + '" style="color:var(--accent);font-size:0.8rem;" onclick="event.stopPropagation()">' + c.phone + '</a>' : ''}${c.email ? ' <a href="mailto:' + c.email + '" style="color:var(--accent);font-size:0.8rem;" onclick="event.stopPropagation()">' + c.email + '</a>' : ''}`).join(' ¬∑ ') : titleCase(p.primary_contact || '')}
            </div>` : ''}
          </div>
          ${expandedId === p.id ? renderDetail(p) : ''}
        </div>
      `).join('');
    }

    function renderDetail(p) {
      const contacts = p.contacts || [];
      const activities = p.activities || [];

      return `
        <div class="prospect-detail" style="display:block;">
          <!-- Editable Fields -->
          <div class="detail-section" style="padding:10px;">
            <div class="detail-section-title">Property Info</div>
            <div class="prop-info-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
              <div class="field-group">
                <label class="field-label">Name</label>
                <input class="field-input" value="${esc(p.name)}" onchange="updateField(${p.id},'name',this.value)" style="padding:6px 8px;font-size:0.85rem;">
              </div>
              <div class="field-group">
                <label class="field-label">Type</label>
                <select class="field-input" onchange="updateField(${p.id},'property_type',this.value)" style="padding:6px 8px;font-size:0.85rem;">
                  <option value="">Select...</option>
                  ${['Apartments','Condos','Extended Stay','Office','Gym','Warehouse','Senior Living','Skilled Nursing','Other'].map(t =>
                    `<option value="${t}" ${p.property_type === t ? 'selected' : ''}>${t}</option>`
                  ).join('')}
                </select>
              </div>
              <div class="field-group">
                <label class="field-label">Units</label>
                <input class="field-input" value="${esc(p.units || '')}" onchange="updateField(${p.id},'units',this.value)" style="padding:6px 8px;font-size:0.85rem;">
              </div>
              <div class="field-group" style="grid-column:1/-1;">
                <label class="field-label">Address</label>
                <input class="field-input" value="${esc(p.address || '')}" onchange="updateField(${p.id},'address',this.value)" style="padding:6px 8px;font-size:0.85rem;">
              </div>
              <div class="field-group">
                <label class="field-label">Hours</label>
                <input class="field-input" value="${esc(p.hours || '')}" onchange="updateField(${p.id},'hours',this.value)" style="padding:6px 8px;font-size:0.85rem;">
              </div>
            </div>
          </div>

          <!-- Contacts (inline editable) -->
          <div class="detail-section" style="margin-top:12px;">
            <div class="detail-section-title">Contacts</div>
            ${contacts.length ? `<div class="contact-grid-header" style="display:grid;grid-template-columns:2fr 2fr 1.5fr 3fr auto;gap:8px;margin-bottom:6px;align-items:center;">
              <span class="field-label">Name</span>
              <span class="field-label">Role</span>
              <span class="field-label">Phone</span>
              <span class="field-label">Email</span>
              <span></span>
            </div>` : ''}
            ${contacts.map((c, ci) => `
              <div class="contact-card contact-grid-row" style="display:grid;grid-template-columns:2fr 2fr 1.5fr 3fr auto;gap:8px;align-items:center;">
                <div class="field-group contact-field"><label class="field-label contact-field-label">Name</label><input class="field-input" value="${esc(c.name)}" placeholder="Name" style="font-weight:600;width:100%;" onchange="updateContact(${p.id},${c.id},'name',this.value)"></div>
                <div class="field-group contact-field"><label class="field-label contact-field-label">Role</label><input class="field-input" value="${esc(c.role || '')}" placeholder="Role" style="font-size:0.8rem;width:100%;" onchange="updateContact(${p.id},${c.id},'role',this.value)"></div>
                <div class="field-group contact-field"><label class="field-label contact-field-label">Phone</label><input class="field-input" value="${esc(c.phone || '')}" placeholder="Phone" style="width:100%;" onchange="updateContact(${p.id},${c.id},'phone',this.value)"></div>
                <div class="field-group contact-field"><label class="field-label contact-field-label">Email</label><input class="field-input" value="${esc(c.email || '')}" placeholder="Email" style="width:100%;" onchange="updateContact(${p.id},${c.id},'email',this.value)"></div>
                <button class="contact-delete" style="background:none;border:none;color:var(--hot);cursor:pointer;font-size:14px;" onclick="deleteContact(${p.id},${c.id})" title="Remove contact">‚úï</button>
              </div>
            `).join('')}
            <button class="action-btn" style="margin-top:8px;" onclick="showAddContact(${p.id})">+ Add Contact</button>
          </div>

          <!-- Sales Notes -->
          <div class="notes-box">
            <label class="sales">üìù Sales Notes</label>
            <textarea onchange="updateField(${p.id},'notes',this.value)" oninput="autoResize(this)" onfocus="autoResize(this)">${esc(p.notes || '')}</textarea>
          </div>

          <!-- Kurtis Notes -->
          <div class="notes-box kurtis">
            <label class="kurtis">üë§ Kurtis Notes</label>
            <textarea onchange="updateField(${p.id},'kurtis_notes',this.value)" oninput="autoResize(this)" onfocus="autoResize(this)">${esc(p.kurtis_notes || '')}</textarea>
          </div>

          <!-- Activities -->
          <div class="activities-section">
            <div class="detail-section-title" style="margin-bottom:8px;">Activities</div>
            ${activities.length ? activities.map(a => `
              <div class="activity-item ${a.type}" style="position:relative;">
                <button style="position:absolute;top:6px;right:6px;background:none;border:none;color:var(--hot);cursor:pointer;font-size:12px;opacity:0.5;" onclick="deleteActivity(${p.id},${a.id})" title="Delete activity" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">‚úï</button>
                <div class="activity-type">${a.type}</div>
                <div class="activity-desc">${a.description || ''}</div>
                ${a.outcome ? `<div style="font-size:0.8rem;color:var(--accent);margin-top:2px;">Outcome: ${a.outcome}</div>` : ''}
                ${a.next_action ? `<div style="font-size:0.8rem;color:var(--warm);margin-top:2px;">‚Üí ${a.next_action}</div>` : ''}
                <div class="activity-date">${new Date(a.created_at).toLocaleDateString()}</div>
              </div>
            `).join('') : '<p style="color:var(--muted);font-size:0.85rem;">No activities logged yet.</p>'}
          </div>

          <!-- Action bar -->
          <div class="action-bar">
            <button class="action-btn" onclick="logActivity(${p.id},'call')">üìû Log Call</button>
            <button class="action-btn" onclick="logActivity(${p.id},'pop-in')">üö∂ Log Pop-in</button>
            <button class="action-btn" onclick="logActivity(${p.id},'email')">üìß Log Email</button>
          </div>
        </div>
      `;
    }

    // Tag cycling: new ‚Üí warm ‚Üí hot ‚Üí signed ‚Üí closed ‚Üí new
    const TAG_CYCLE = [
      { priority: 'normal', status: 'new' },
      { priority: 'warm', status: 'active' },
      { priority: 'hot', status: 'active' },
      { priority: 'normal', status: 'signed' },
      { priority: 'normal', status: 'closed' }
    ];

    function getBadgeClass(p) {
      if (p.status === 'signed') return 'signed';
      if (p.priority === 'hot') return 'hot';
      if (p.priority === 'warm') return 'warm';
      if (p.status === 'closed') return 'closed';
      return 'new';
    }

    function getBadgeLabel(p) {
      if (p.status === 'signed') return '‚úÖ Signed';
      if (p.priority === 'hot') return 'üî• Hot';
      if (p.priority === 'warm') return 'üü† Warm';
      if (p.status === 'closed') return '‚õî Stale';
      return 'üÜï New';
    }

    function toggleNeedsAction(id) {
      const p = prospects.find(p => p.id === id);
      if (!p) return;
      p.needs_action = !p.needs_action;
      fetch(`/api/prospects/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ needs_action: p.needs_action })
      }).then(() => {
        const el = document.getElementById(`saved-${id}`);
        if (el) { el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1500); }
      });
      renderProspects();
    }

    function cycleTag(id) {
      const p = prospects.find(p => p.id === id);
      if (!p) return;

      // Find current position in cycle
      let idx = TAG_CYCLE.findIndex(t =>
        t.priority === p.priority && (t.status === p.status || (t.status === 'new' && p.status === 'new') || (t.status === 'active' && p.status === 'active'))
      );
      if (idx === -1) idx = 0;

      // Move to next
      const next = TAG_CYCLE[(idx + 1) % TAG_CYCLE.length];
      p.priority = next.priority;
      p.status = next.status;

      // Save both fields
      fetch(`/api/prospects/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ priority: next.priority, status: next.status })
      }).then(() => {
        const el = document.getElementById(`saved-${id}`);
        if (el) { el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1500); }
        loadStats();
      });

      renderProspects();
    }

    function esc(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function titleCase(str) {
      return String(str).replace(/\S+/g, w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
    }

    function actIcon(type) {
      if (type === 'call') return 'üìû';
      if (type === 'pop-in') return 'üö∂';
      if (type === 'email') return 'üìß';
      return 'üìû'; // default to call for legacy types like outreach
    }

    function groupActivitiesByDate(activities) {
      const groups = {};
      for (const a of activities) {
        const date = new Date(a.created_at).toLocaleDateString('en', { month: 'short', day: 'numeric' });
        if (!groups[date]) groups[date] = [];
        groups[date].push(a);
      }
      return Object.entries(groups);
    }

    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    }

    function updateContact(prospectId, contactId, field, value) {
      const p = prospects.find(p => p.id === prospectId);
      if (p?.contacts) {
        const c = p.contacts.find(c => c.id === contactId);
        if (c) c[field] = value;
      }
      clearTimeout(saveTimers['c' + contactId]);
      saveTimers['c' + contactId] = setTimeout(async () => {
        await fetch(`/api/contacts/${contactId}`, {
          method: 'PUT', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });
        const el = document.getElementById(`saved-${prospectId}`);
        if (el) { el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1500); }
      }, 500);
    }

    async function deleteContact(prospectId, contactId) {
      if (!confirm('Remove this contact?')) return;
      await fetch(`/api/contacts/${contactId}`, { method: 'DELETE' });
      const res = await fetch(`/api/prospects/${prospectId}`);
      const detail = await res.json();
      const idx = prospects.findIndex(p => p.id === prospectId);
      if (idx >= 0) prospects[idx] = detail;
      renderProspects();
    }

    async function deleteActivity(prospectId, activityId) {
      if (!confirm('Delete this activity?')) return;
      await fetch(`/api/activities/${activityId}`, { method: 'DELETE' });
      const res = await fetch(`/api/prospects/${prospectId}`);
      const detail = await res.json();
      const idx = prospects.findIndex(p => p.id === prospectId);
      if (idx >= 0) prospects[idx] = detail;
      renderProspects();
      loadStats();
    }

    async function toggleExpand(id) {
      if (expandedId === id) {
        expandedId = null;
      } else {
        // Fetch fresh detail data
        const res = await fetch(`/api/prospects/${id}`);
        const detail = await res.json();
        const idx = prospects.findIndex(p => p.id === id);
        if (idx >= 0) prospects[idx] = detail;
        expandedId = id;
      }
      renderProspects();
      if (expandedId) {
        setTimeout(() => {
          const card = document.getElementById(`card-${expandedId}`);
          card?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          card?.querySelectorAll('.notes-box textarea').forEach(t => autoResize(t));
        }, 50);
      }
    }

    // Auto-save on field change
    function updateField(id, field, value) {
      // Update local data
      const p = prospects.find(p => p.id === id);
      if (p) p[field] = value;

      // Debounce save
      clearTimeout(saveTimers[id]);
      saveTimers[id] = setTimeout(async () => {
        await fetch(`/api/prospects/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });
        // Flash saved indicator
        const el = document.getElementById(`saved-${id}`);
        if (el) { el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1500); }
        loadStats();
      }, 500);
    }

    // Filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderProspects();
      });
    });
    document.getElementById('search').addEventListener('input', renderProspects);

    // Add new prospect
    function showAddModal() {
      document.getElementById('prospectForm').reset();
      document.getElementById('prospectModal').classList.add('active');
    }
    function closeModal() { document.getElementById('prospectModal').classList.remove('active'); }

    async function addProspect() {
      const data = {
        name: document.getElementById('addName').value,
        property_type: document.getElementById('addPropertyType').value,
        units: document.getElementById('addUnits').value,
        address: document.getElementById('addAddress').value,
        phone: document.getElementById('addPhone').value,
        hours: document.getElementById('addHours').value,
        status: 'new', priority: 'normal', notes: '', kurtis_notes: ''
      };
      await fetch('/api/prospects', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      closeModal();
      loadData();
    }

    // Activity
    function logActivity(prospectId, type) {
      document.getElementById('activityProspectId').value = prospectId;
      document.getElementById('activityType').value = type;
      document.getElementById('activityTitle').textContent = `Log ${type.charAt(0).toUpperCase() + type.slice(1)}`;
      document.getElementById('activityForm').reset();
      document.getElementById('activityModal').classList.add('active');
    }
    function closeActivityModal() { document.getElementById('activityModal').classList.remove('active'); }

    async function saveActivity() {
      const pid = document.getElementById('activityProspectId').value;
      const data = {
        type: document.getElementById('activityType').value,
        description: document.getElementById('activityDesc').value,
        outcome: document.getElementById('activityOutcome').value,
        next_action: document.getElementById('nextAction').value,
        next_action_date: document.getElementById('nextActionDate').value
      };
      await fetch(`/api/prospects/${pid}/activities`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      closeActivityModal();
      // Refresh the expanded card
      expandedId = parseInt(pid);
      const res = await fetch(`/api/prospects/${pid}`);
      const detail = await res.json();
      const idx = prospects.findIndex(p => p.id === parseInt(pid));
      if (idx >= 0) prospects[idx] = detail;
      renderProspects();
      loadStats();
    }

    // Contacts
    function showAddContact(prospectId) {
      document.getElementById('contactProspectId').value = prospectId;
      document.getElementById('contactForm').reset();
      document.getElementById('contactModal').classList.add('active');
    }
    function closeContactModal() { document.getElementById('contactModal').classList.remove('active'); }

    async function saveContact() {
      const pid = document.getElementById('contactProspectId').value;
      const data = {
        name: titleCase(document.getElementById('contactName').value.trim()),
        role: document.getElementById('contactRole').value,
        email: document.getElementById('contactEmail').value,
        phone: document.getElementById('contactPhone').value,
        is_primary: document.getElementById('contactPrimary').checked
      };
      await fetch(`/api/prospects/${pid}/contacts`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      closeContactModal();
      expandedId = parseInt(pid);
      const res = await fetch(`/api/prospects/${pid}`);
      const detail = await res.json();
      const idx = prospects.findIndex(p => p.id === parseInt(pid));
      if (idx >= 0) prospects[idx] = detail;
      renderProspects();
    }

    // Delete
    async function deleteProspect(id, name) {
      if (!confirm(`Remove "${name}" from the list? This cannot be undone.`)) return;
      await fetch(`/api/prospects/${id}`, { method: 'DELETE' });
      expandedId = null;
      loadData();
    }

    // Mini Map
    const map = L.map('miniMap').setView([36.10, -115.18], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 18
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);
    const markerColors = { hot: '#e53e3e', warm: '#dd6b20', signed: '#38a169', new: '#3182ce', closed: '#a0aec0' };

    function getMarkerColor(p) {
      if (p.status === 'signed') return markerColors.signed;
      if (p.priority === 'hot') return markerColors.hot;
      if (p.priority === 'warm') return markerColors.warm;
      if (p.status === 'closed') return markerColors.closed;
      return markerColors.new;
    }

    function geocodeAndPlot() {
      markers.clearLayers();
      // Server pre-geocodes all addresses ‚Äî just plot what's available
      prospects.filter(p => p.lat && p.lng).forEach(p => addMarker(p));
    }

    function addMarker(p) {
      const color = getMarkerColor(p);
      const icon = L.divIcon({
        className: '',
        html: `<div style="width:12px;height:12px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`,
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      });
      const m = L.marker([p.lat, p.lng], { icon }).addTo(markers);
      m.bindPopup(`<strong>${p.name}</strong><br>${p.property_type || ''}<br><a href="https://www.google.com/maps/search/${encodeURIComponent(p.address)}" target="_blank">Open in Maps</a>`);
    }

    // Override loadData to also plot map
    const _origLoadData = loadData;
    loadData = async function() {
      await _origLoadData();
      geocodeAndPlot();
    };

    loadData();
  </script>
</body>
</html>
